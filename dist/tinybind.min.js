!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).tinybind=e()}(this,function(){"use strict";var r=["prefix","templateDelimiters","rootInterface","preloadData","handler"],s=["binders","formatters","adapters"],n=/^'.*'$|^".*"$/;function i(t){var e=0,i=t;return n.test(t)?i=t.slice(1,-1):"true"===t?i=!0:"false"===t?i=!1:"null"===t?i=null:"undefined"===t?i=void 0:isNaN(t)?e=1:i=Number(t),{type:e,value:i}}function h(t,e){for(var i,n,r=t.length,s=0,a=e[0],o=e[1];s<r;){if((n=t.indexOf(a,s))<0){i&&i.push({type:0,value:t.slice(s)});break}if(i=i||[],0<n&&s<n&&i.push({type:0,value:t.slice(s,n)}),s=n+a.length,(n=t.indexOf(o,s))<0){var h=t.slice(s-o.length),c=i[i.length-1];c&&0===c.type?c.value+=h:i.push({type:0,value:h});break}c=t.slice(s,n).trim();i.push({type:1,value:c}),s=n+o.length}return i}var a,o,c,v={binders:{},formatters:{},adapters:{},_prefix:"rv",_fullPrefix:"rv-",get prefix(){return this._prefix},set prefix(t){this._prefix=t,this._fullPrefix=t+"-"},parseTemplate:h,parseType:i,templateDelimiters:["{","}"],rootInterface:".",preloadData:!0,handler:function(t,e,i){this.call(t,e,i.view.models)},fallbackBinder:function(t,e){null!=e?t.setAttribute(this.type,e):t.removeAttribute(this.type)},configure:function(t){var n=this;t&&Object.keys(t).forEach(function(e){var i=t[e];-1<s.indexOf(e)?Object.keys(i).forEach(function(t){n[e][t]=i[t]}):n[e]=i})}};function u(t){return"object"==typeof t&&null!==t}var l=function(){function i(t,e,i){this.keypath=e,this.callback=i,this.objectPath=[],this.parse(),this.obj=this.getRootObject(t),u(this.target=this.realize())&&this.set(!0,this.key,this.target,this.callback)}i.updateOptions=function(t){a=t.adapters,o=Object.keys(a),c=t.rootInterface},i.tokenize=function(t,e){for(var i,n=[],r={i:e,path:""},s=0;s<t.length;s++)i=t.charAt(s),~o.indexOf(i)?(n.push(r),r={i:i,path:""}):r.path+=i;return n.push(r),n};var t=i.prototype;return t.parse=function(){var t,e;if(!o.length)throw new Error("[Observer] "+"Must define at least one adapter interface.");t=~o.indexOf(this.keypath[0])?(e=this.keypath[0],this.keypath.substr(1)):(e=c,this.keypath),this.tokens=i.tokenize(t,e),this.key=this.tokens.pop()},t.realize=function(){for(var t,e,i=this.obj,n=-1,r=0;r<this.tokens.length;r++)e=this.tokens[r],u(i)?(void 0!==this.objectPath[r]?i!==(t=this.objectPath[r])&&(this.set(!1,e,t,this),this.set(!0,e,i,this),this.objectPath[r]=i):(this.set(!0,e,i,this),this.objectPath[r]=i),i=this.get(e,i)):(-1===n&&(n=r),(t=this.objectPath[r])&&this.set(!1,e,t,this));return-1!==n&&this.objectPath.splice(n),i},t.sync=function(){var t,e,i;(t=this.realize())!==this.target?(u(this.target)&&this.set(!1,this.key,this.target,this.callback),u(t)&&this.set(!0,this.key,t,this.callback),e=this.value(),this.target=t,((i=this.value())!==e||i instanceof Function)&&this.callback.sync()):t instanceof Array&&this.callback.sync()},t.value=function(){if(u(this.target))return this.get(this.key,this.target)},t.setValue=function(t){u(this.target)&&a[this.key.i].set(this.target,this.key.path,t)},t.get=function(t,e){return a[t.i].get(e,t.path)},t.set=function(t,e,i,n){a[e.i][t?"observe":"unobserve"](i,e.path,n)},t.unobserve=function(){for(var t,e,i=0;i<this.tokens.length;i++)e=this.tokens[i],(t=this.objectPath[i])&&this.set(!1,e,t,this);u(this.target)&&this.set(!1,this.key,this.target,this.callback)},t.getRootObject=function(t){var e,i;if(!t.$parent)return t;for(e=(this.tokens.length?this.tokens[0]:this.key).path,i=t;i.$parent&&void 0===i[e];)i=i.$parent;return i},i}();function f(t,e){var i=!1;if(3===e.nodeType){var n=h(e.data,v.templateDelimiters);if(n){for(var r=0;r<n.length;r++){var s=n[r],a=document.createTextNode(s.value);e.parentNode.insertBefore(a,e),1===s.type&&t.buildBinding(a,null,s.value,k,null)}e.parentNode.removeChild(e)}i=!0}else 1===e.nodeType&&(i=t.traverse(e));if(!i)for(var o=0;o<e.childNodes.length;o++)f(t,e.childNodes[o])}function d(t,e){return t=t.binder&&t.binder.priority||0,(e.binder&&e.binder.priority||0)-t}function p(t){return t.trim()}function b(t){return null!=t?t.toString():void 0}var y=/[^\s']+|'([^']|'[^\s])*'|"([^"]|"[^\s])*"/g,m=/\s+/,g=function(){function t(t,e,i,n,r,s,a){this.view=t,this.el=e,this.type=i,this.keypath=n,this.binder=r,this.arg=s,this.formatters=a,this.formatterObservers={},this.model=void 0}var e=t.prototype;return e.observe=function(t,e){return new l(t,e,this)},e.parseTarget=function(){var t;this.keypath?0===(t=i(this.keypath)).type?this.value=t.value:(this.observer=this.observe(this.view.models,this.keypath),this.model=this.observer.target):this.value=void 0},e.parseFormatterArguments=function(t,n){var r=this;return t.map(i).map(function(t,e){var i=t.type,t=t.value;return 0===i?t:(r.formatterObservers[n]||(r.formatterObservers[n]={}),(i=r.formatterObservers[n][e])||(i=r.observe(r.view.models,t),r.formatterObservers[n][e]=i),i.value())})},e.formattedValue=function(t){var r=this;return this.formatters.reduce(function(t,e,i){var e=e.match(y),n=e.shift(),n=r.view.options.formatters[n],e=r.parseFormatterArguments(e,i);return n&&n.read instanceof Function?t=n.read.apply(n,[t].concat(e)):n instanceof Function&&(t=n.apply(void 0,[t].concat(e))),t},t)},e.eventHandler=function(e){var i=this,n=i.view.options.handler;return function(t){n.call(e,this,t,i)}},e.set=function(t){t=t instanceof Function&&!this.binder.function?this.formattedValue(t.call(this.model)):this.formattedValue(t);var e=this.binder.routine||this.binder;e instanceof Function&&e.call(this,this.el,t)},e.sync=function(){this.observer?(this.model=this.observer.target,this.set(this.observer.value())):this.set(this.value)},e.publish=function(){var t,r=this;this.observer&&(t=this.formatters.reduceRight(function(t,e,i){var e=e.split(m),n=e.shift(),n=r.view.options.formatters[n],e=r.parseFormatterArguments(e,i);return t=n&&n.publish?n.publish.apply(n,[t].concat(e)):t},this.getValue(this.el)),this.observer.setValue(t))},e.bind=function(){this.parseTarget(),this.binder.hasOwnProperty("bind")&&this.binder.bind.call(this,this.el),this.view.options.preloadData&&this.sync()},e.unbind=function(){var i=this;this.binder.unbind&&this.binder.unbind.call(this,this.el),this.observer&&this.observer.unobserve(),Object.keys(this.formatterObservers).forEach(function(t){var e=i.formatterObservers[t];Object.keys(e).forEach(function(t){e[t].unobserve()})}),this.formatterObservers={}},e.update=function(t){void 0===t&&(t={}),this.observer&&(this.model=this.observer.target),this.binder.update&&this.binder.update.call(this,t)},e.getValue=function(t){if(this.binder&&this.binder.getValue)return this.binder.getValue.call(this,t);var e=t;if("checkbox"===e.type)return e.checked;if("select-multiple"!==e.type)return e.value;for(var i,n=[],r=0;r<e.options.length;r++)(i=e.options[r]).selected&&n.push(i.value);return n},t}(),k={routine:function(t,e){t.data=null!=e?e:""}},O=/((?:'[^']*')*(?:(?:[^\|']*(?:'[^']*')+[^\|']*)+|[^\|]+))|^$/g,_=function(){function t(t,e,i){t.jquery||t instanceof Array?this.els=t:this.els=[t],this.models=e,this.options=i,this.build()}var e=t.prototype;return e.buildBinding=function(t,e,i,n,r){var i=i.match(O).map(p),s=i.shift();this.bindings.push(new g(this,t,e,s,n,r,i))},e.build=function(){this.bindings=[];for(var t=this.els,e=0,i=t.length;e<i;e++)f(this,t[e]);this.bindings.sort(d)},e.traverse=function(t){for(var e,i,n,r,s=v._fullPrefix,a="SCRIPT"===t.nodeName||"STYLE"===t.nodeName,o=t.attributes,h=[],c=this.options.starBinders,u=0,l=o.length;u<l;u++){var f=o[u];if(0===f.name.indexOf(s)){if(e=f.name.slice(s.length),r=void 0,!(i=this.options.binders[e]))for(var d=0;d<c.length;d++)if(n=c[d],e.slice(0,n.length-1)===n.slice(0,-1)){i=this.options.binders[n],r=e.slice(n.length-1);break}if((i=i||v.fallbackBinder).block)return this.buildBinding(t,e,f.value,i,r),t.removeAttribute(f.name),!0;h.push({attr:f,binder:i,type:e,arg:r})}}for(var p=0;p<h.length;p++){var b=h[p];this.buildBinding(t,b.type,b.attr.value,b.binder,b.arg),t.removeAttribute(b.attr.name)}return a},e.bind=function(){this.bindings.forEach(function(t){t.bind()})},e.unbind=function(){this.bindings.forEach(function(t){t.unbind()})},e.sync=function(){this.bindings.forEach(function(t){t.sync()})},e.publish=function(){this.bindings.forEach(function(t){t.binder&&t.binder.publishes&&t.publish()})},e.update=function(e){var i=this;void 0===e&&(e={}),Object.keys(e).forEach(function(t){i.models[t]=e[t]}),this.bindings.forEach(function(t){t.update&&t.update(e)})},t}(),w=["push","pop","shift","unshift","sort","reverse","splice"],t={counter:0,weakmap:{},weakReference:function(t){var e;return t.hasOwnProperty("__rv")||(e=this.counter++,Object.defineProperty(t,"__rv",{value:e})),this.weakmap[t.__rv]||(this.weakmap[t.__rv]={callbacks:{}}),this.weakmap[t.__rv]},cleanupWeakReference:function(t,e){Object.keys(t.callbacks).length||t.pointers&&Object.keys(t.pointers).length||delete this.weakmap[e]},stubFunction:function(r,t){var s=r[t],a=this.weakReference(r),o=this.weakmap;r[t]=function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];var n=s.apply(r,e);return Object.keys(a.pointers).forEach(function(t){var e=a.pointers[t];o[t]&&o[t].callbacks[e]instanceof Array&&o[t].callbacks[e].forEach(function(t){t.sync()})}),n}},observeArray:function(e,t,i){var n,r=this;e instanceof Array&&((n=this.weakReference(e)).pointers||(n.pointers={},w.forEach(function(t){r.stubFunction(e,t)})),n.pointers[t]||(n.pointers[t]=[]),-1===n.pointers[t].indexOf(i))&&n.pointers[t].push(i)},unobserveArray:function(t,e,i){var n,r;t instanceof Array&&null!=t.__rv&&(n=this.weakmap[t.__rv])&&(r=n.pointers[e])&&(-1<(i=r.indexOf(i))&&r.splice(i,1),r.length||delete n.pointers[e],this.cleanupWeakReference(n,t.__rv))},observe:function(i,n,t){var r,e,s=this,a=this.weakReference(i).callbacks;a[n]||(a[n]=[],(e=Object.getOwnPropertyDescriptor(i,n))&&(e.get||e.set||!e.configurable))||(r=i[n],Object.defineProperty(i,n,{enumerable:!0,get:function(){return r},set:function(t){var e;t!==r&&(s.unobserveArray(r,i.__rv,n),r=t,e=s.weakmap[i.__rv])&&((e=e.callbacks[n])&&e.forEach(function(t){t.sync()}),s.observeArray(t,i.__rv,n))}})),-1===a[n].indexOf(t)&&a[n].push(t),this.observeArray(i[n],i.__rv,n)},unobserve:function(t,e,i){var n,r=this.weakmap[t.__rv];r&&(n=r.callbacks[e])&&(-1<(i=n.indexOf(i))&&(n.splice(i,1),n.length||(delete r.callbacks[e],this.unobserveArray(t[e],t.__rv,e))),this.cleanupWeakReference(r,t.__rv))},get:function(t,e){return t[e]},set:function(t,e,i){t[e]=i}};function j(t,e,i){var n=t.el.cloneNode(!0),e=new _(n,e,t.view.options);return e.bind(),t.marker.parentNode.insertBefore(n,i),e}var e={"on-*":{function:!0,priority:1e3,unbind:function(t){this.handler&&t.removeEventListener(this.arg,this.handler)},routine:function(t,e){this.handler&&t.removeEventListener(this.arg,this.handler),this.handler=this.eventHandler(e),t.addEventListener(this.arg,this.handler)}},"each-*":{block:!0,priority:4e3,bind:function(t){this.marker?this.iterated.forEach(function(t){t.bind()}):(this.marker=document.createComment(" tinybind: "+this.type+" "),this.iterated=[],t.parentNode.insertBefore(this.marker,t),t.parentNode.removeChild(t))},unbind:function(t){this.iterated&&this.iterated.forEach(function(t){t.unbind()})},routine:function(t,e){var o=this,h=this.arg,c=(e=e||[],t.getAttribute("index-property")||"$index");if(e.forEach(function(t,e){var i={$parent:o.view.models},n=(i[c]=e,i[h]=t,o.iterated[e]);if(n)if(n.models[h]!==t){for(var r,s,a=e+1;a<o.iterated.length;a++)if((s=o.iterated[a]).models[h]===t){r=a;break}void 0!==r?(o.iterated.splice(r,1),o.marker.parentNode.insertBefore(s.els[0],n.els[0]),s.models[c]=e):s=j(o,i,n.els[0]),o.iterated.splice(e,0,s)}else n.models[c]=e;else{e=o.marker;o.iterated.length&&(e=o.iterated[o.iterated.length-1].els[0]),n=j(o,i,e.nextSibling),o.iterated.push(n)}}),this.iterated.length>e.length)for(var i=this.iterated.length-e.length,n=function(){var t=o.iterated.pop();t.unbind(),o.marker.parentNode.removeChild(t.els[0])},r=0;r<i;r++)n();"OPTION"===t.nodeName&&this.view.bindings.forEach(function(t){t.el===o.marker.parentNode&&"value"===t.type&&t.sync()})},update:function(e){var i=this,n={};Object.keys(e).forEach(function(t){t!==i.arg&&(n[t]=e[t])}),this.iterated.forEach(function(t){t.update(n)})}},"class-*":function(t,e){var i=" "+t.className+" ";!e==-1<i.indexOf(" "+this.arg+" ")&&(t.className=e?t.className+" "+this.arg:i.replace(" "+this.arg+" "," ").trim())},text:function(t,e){t.textContent=null!=e?e:""},html:function(t,e){t.innerHTML=null!=e?e:""},show:function(t,e){t.style.display=e?"":"none"},hide:function(t,e){t.style.display=e?"none":""},enabled:function(t,e){t.disabled=!e},disabled:function(t,e){t.disabled=!!e},checked:{publishes:!0,priority:2e3,bind:function(t){var e=this;this.callback||(this.callback=function(){e.publish()}),t.addEventListener("change",this.callback)},unbind:function(t){t.removeEventListener("change",this.callback)},routine:function(t,e){"radio"===t.type?t.checked=b(t.value)===b(e):t.checked=!!e}},value:{publishes:!0,priority:3e3,bind:function(t){var e;this.isRadio="INPUT"===t.tagName&&("radio"===t.type||"checkbox"===t.type),this.isRadio||(this.event=t.getAttribute("event-name")||("SELECT"===t.tagName?"change":"input"),(e=this).callback||(this.callback=function(){e.publish()}),t.addEventListener(this.event,this.callback))},unbind:function(t){this.isRadio||t.removeEventListener(this.event,this.callback)},routine:function(t,e){if(this.isRadio)t.setAttribute("value",e);else if("select-multiple"===t.type){if(e instanceof Array)for(var i=0;i<t.length;i++){var n=t[i];n.selected=-1<e.indexOf(n.value)}}else b(e)!==b(t.value)&&(t.value=null!=e?e:"")}},if:{block:!0,priority:4e3,bind:function(t){this.marker?!1===this.bound&&this.nested&&this.nested.bind():(this.marker=document.createComment(" tinybind: "+this.type+" "+this.keypath+" "),this.attached=!1,t.parentNode.insertBefore(this.marker,t),t.parentNode.removeChild(t)),this.bound=!0},unbind:function(){this.nested&&(this.nested.unbind(),this.bound=!1)},routine:function(t,e){!!e!==this.attached&&(e?(this.nested||(this.nested=new _(t,this.view.models,this.view.options),this.nested.bind()),this.marker.parentNode.insertBefore(t,this.marker.nextSibling),this.attached=!0):(t.parentNode.removeChild(t),this.attached=!1))},update:function(t){this.nested&&this.nested.update(t)}}};function E(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,function(t){t=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0===i)return("string"===e?String:Number)(t);i=i.call(t,e||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}(t,"string");return"symbol"==typeof t?t:String(t)}(n.key),n)}}function x(t){return(x=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function N(t,e){return(N=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function P(t,e,i){return(P=function(){if("undefined"!=typeof Reflect&&Reflect.construct&&!Reflect.construct.sham){if("function"==typeof Proxy)return 1;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),1}catch(t){}}}()?Reflect.construct.bind():function(t,e,i){var n=[null];n.push.apply(n,e);e=new(Function.bind.apply(t,n));return i&&N(e,i.prototype),e}).apply(null,arguments)}function A(t){var i="function"==typeof Map?new Map:void 0;return function(t){if(null===t||-1===Function.toString.call(t).indexOf("[native code]"))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==i){if(i.has(t))return i.get(t);i.set(t,e)}function e(){return P(t,arguments,x(this).constructor)}return e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),N(e,t)}(t)}var R=function(t){function e(){return t.apply(this,arguments)||this}i=t,(r=e).prototype=Object.create(i.prototype),N(r.prototype.constructor=r,i);var i,n,r=e.prototype;return r.connectedCallback=function(){var t=this.constructor.__templateEl.content.cloneNode(!0);for(this.__tinybindView=v.bind(t,this);this.firstChild;)this.removeChild(this.firstChild);this.appendChild(t)},r.disconnectedCallback=function(){this.__tinybindView.unbind()},r.attributeChangedCallback=function(t,e,i){e!==i&&(this[this.constructor.__propAttributeMap[t]]=i)},i=e,r=[{key:"observedAttributes",get:function(){var t=this.template;if(!t)throw new Error("No template declared for "+this.name);this.__templateEl=document.createElement("template"),this.__templateEl.innerHTML=t;var i=this.__propAttributeMap={},n=[],r=this.properties;return r&&Object.keys(r).forEach(function(t){var e=r[t],e="string"==typeof e?e:t;i[e]=t,n.push(e)}),n}}],(n=null)&&E(i.prototype,n),r&&E(i,r),Object.defineProperty(i,"prototype",{writable:!1}),e}(A(HTMLElement));return v.binders=e,v.formatters={watch:function(t){return t},not:function(t){return!t},negate:function(t){return!t}},v.adapters["."]=t,v.Component=R,v.bind=function(t,e,i){var n={},t=(e=e||{},i=i||{},s.forEach(function(e){n[e]=Object.create(null),i[e]&&Object.keys(i[e]).forEach(function(t){n[e][t]=i[e][t]}),Object.keys(v[e]).forEach(function(t){n[e][t]||(n[e][t]=v[e][t])})}),r.forEach(function(t){var e=i[t];n[t]=null!=e?e:v[t]}),n.starBinders=Object.keys(n.binders).filter(function(t){return 0<t.indexOf("*")}),l.updateOptions(n),new _(t,e,n));return t.bind(),t},v});
//# sourceMappingURL=tinybind.min.js.map
